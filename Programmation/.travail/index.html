<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 2</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
        type: Phaser.AUTO,
        width: 1280,
        height: 720,
        input: {
            gamepad: true
        },
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 105 },
                debug: true
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

var player;

var cursors;
var recif;
var algues;
var emitter;
var emitter2;
var particles;
var particles2;
var ennemi_bouteille;

var game = new Phaser.Game(config);

    function preload ()
    {
        this.load.image('background', 'assets/background.png');
        this.load.image('light', 'assets/lumiere_principale.png');
        this.load.image('plan_01', 'assets/Recif_03.png');
        //this.load.image('plan_01_Flip', 'assets/Algue_01_Flip.png');
        this.load.image('plan_02', 'assets/Recif_02.png');
        this.load.image('plan_02_Flip', 'assets/Recif_02_Flip.png');
        this.load.image('plan_03', 'assets/Recif_01.png');
        this.load.image('plan_03_Flip', 'assets/Recif_01_Flip.png');
        this.load.image('station', 'assets/background_station.png');
        this.load.spritesheet('sous-marin', 'assets/spriteSheet.png', { frameWidth: 367.392857, frameHeight: 178 });
        this.load.spritesheet('algues','assets/sprite_algue.png', {frameWidth: 2553.25, frameHeight: 295 });
        //this.load.spritesheet('sous-marin_bras','assets/spriteSheet_bras.png',{frameWidth: 366.88,frameHeight: 178});
        this.load.image('particule_bulle','assets/particule_bulle.png');
        this.load.image('particules2', 'assets/particule_bulle.png');
        this.load.image('ennemi_bouteille', 'assets/ennemi_bouteille.png');
    }
    

    function create ()
    {
    this.add.image(0,0,'background').setOrigin(0).setScrollFactor(0);
    this.add.image(0,125, 'plan_03').setOrigin(0).setScrollFactor(0.25);
    this.add.image(1280,125, 'plan_03_Flip').setOrigin(0).setScrollFactor(0.25);
    this.add.image(2560, 125, 'plan_03').setOrigin(0).setScrollFactor(0.25);
    this.add.image(0,220, 'plan_02').setOrigin(0).setScrollFactor(0.4);
    this.add.image(1280,220, 'plan_02_Flip').setOrigin(0).setScrollFactor(0.4);
    
    this.add.image(2560,220, 'plan_02').setOrigin(0).setScrollFactor(0.4);
    this.add.image(3840,-80, 'station').setOrigin(0).setScrollFactor(0.4);

    particles = this.add.particles('particule_bulle');
    emitter = particles.createEmitter({
        x:10,
        y:-50,
        speed: 50,
        scale: { start: 0.2, end: 0.5 },
        blendMode: 'ADD',
    });


    particles2 = this.add.particles('particules2');
    emitter2 = particles2.createEmitter({
        x:-70,
        y:10,
        speed: 50,
        scale: { start: 0.2, end: 0.5 },
        blendMode: 'ADD',
    });


    player = this.physics.add.sprite(100, 200, 'sous-marin');
    player.setDamping(false);
    player.setDrag(100);
    player.setMaxVelocity(300);
    player.setSize(24, 20);

    

    ennemi_bouteille = this.physics.add.staticGroup();
    ennemi_bouteille = this.add.image(3000,300, 'ennemi_bouteille');
    
    this.tweens.add({
        targets: ennemi_bouteille,
        x: 2500,
        y: 100,
        duration: 3000,
        yoyo: true,
        delay: 100,
        repeat: -1
    })




    recif = this.physics.add.staticGroup();
    //recif.create(400, 568, 'plan_01').setScale(2).refreshBody();

    recif.create(0,559, 'plan_01').setOrigin(0).setScrollFactor(1);
    recif.create(5115,560, 'plan_01').setOrigin(0).setScrollFactor(1);

    

    algues_2 = this.physics.add.sprite(3790,610, 'algues');
    algues_3 = this.physics.add.sprite(6350,610, 'algues');
    algues = this.physics.add.sprite(1280,610, 'algues');
    this.add.image(0,0, 'light').setOrigin(0).setScrollFactor(0.25);
    this.add.image(1280,0, 'light').setOrigin(0).setScrollFactor(0.25);
    this.add.image(2560,0, 'light').setOrigin(0).setScrollFactor(0.25);
    this.add.image(3840,0, 'light').setOrigin(0).setScrollFactor(0.25);
  
    //  Set the camera and physics bounds to be the size of 4x4 bg images
    this.cameras.main.setBounds(0, 0, 1280 * 12, 720);
    this.physics.world.setBounds(0, 0, 1280 * 12, 720);

    cursors = this.input.keyboard.createCursorKeys();

    this.input.gamepad.on('down', function (pad, button, index) {
        return;
    }),

    


    this.anims.create({
        key : 'algues_1',
        frames: this.anims.generateFrameNumbers('algues', {start:0, end : 3}),
        frameRate : 1,
        repeat: -1
    });
    
    
    
    this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('sous-marin', { start: 0, end: 4 }),
            frameRate: 25,
            repeat: 1
        });

        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('sous-marin', { start: 5, end: 9 }),
            frameRate: 25,
            repeat: 1
        });

        this.anims.create({
            key: 'bras_right',
            frames: this.anims.generateFrameNumbers('sous-marin', { start: 10, end: 18 }),
            frameRate: 25,
            repeat: 0
        });

        this.anims.create({
            key: 'bras_left',
            frames: this.anims.generateFrameNumbers('sous-marin', { start: 19, end: 27 }),
            frameRate: 25,
            repeat: 0
        });

    
        

    text = this.add.text(10, 10, '', { font: '16px Courier', fill: '#00ff00' });
    text.setScrollFactor(0);
    
    
    player.setCollideWorldBounds(true);
    this.cameras.main.startFollow(player, true, 0.05, 0.05);

    
    

    
    this.physics.add.collider(player,ennemi_bouteille);
    this.physics.add.collider(player, recif);
        
    }

    function update ()
    {
        // effet de gravitÃ© //

        //player.setVelocity(5); 
        //player.body.gravity.set(0,0);

        text.setText('Speed: ' + player.body.speed);
        
        // Keyboard //

        if (cursors.left.isDown)
        {
            player.setVelocityX(-150);
            player.anims.play('left', true);
            
            
        }
        else if (cursors.right.isDown)
        {
            player.setVelocityX(150);
            player.anims.play('right', true);
            
        }

        if (cursors.up.isDown)
        {
            player.setVelocityY(-150);
            player.anims.play('right', true);
            
        }
        else if (cursors.down.isDown)
        {
            player.setVelocityY(150);
            player.anims.play('right', true);
            
        }
    
        if (this.input.gamepad.total === 0)
        {
            return;
        }

        // Gamepad //

        var pad = this.input.gamepad.getPad(0);
        
        

        if (pad.axes.length)
        {
            var axisH = pad.axes[0].getValue();
            var axisV = pad.axes[1].getValue();

            player.x += 2 * axisH;
            player.y += 2 * axisV;

            

            player.flipX = (axisH >= -1);

            if (pad.X && axisH >= 0.1){
                player.anims.play('bras_right', true);
                this.physics.velocityFromRotation(player.rotation, 300, player.body.acceleration);
                emitter.startFollow(player);
                emitter2.startFollow(player);
            }
            else if (axisH >= 0.1){
                
                player.anims.play('left',true);
                algues.anims.play('algues_1',true);
                algues_2.anims.play('algues_1',true);
                algues_3.anims.play('algues_1',true);
                this.physics.velocityFromRotation(player.rotation, 300, player.body.acceleration);
                emitter.startFollow(player);
                emitter2.startFollow(player);  
            }
            if (pad.X && axisH <= -0.1){
                player.anims.play('bras_left', true);
                this.physics.velocityFromRotation(player.rotation, -300, player.body.acceleration);
                emitter.startFollow(player);
                emitter2.startFollow(player);
            }
            else if (axisH <= -0.1){
                player.anims.play('right', true);
                player.flipX = (axisH = -1);
                this.physics.velocityFromRotation(player.rotation, -300, player.body.acceleration);
                emitter.startFollow(player);
                emitter2.startFollow(player);  
            }
            if (pad.X && axisV >= 0.1 && axisH <= -0.1){
                player.anims.play('bras_left', true);
                this.physics.velocityFromRotation(player.rotation, -300, player.body.acceleration);
                emitter.startFollow(player);
                emitter2.startFollow(player);
            }
            else if (axisV >= 0.1 && axisH <= -0.1){
                player.anims.play('right', true);
                this.physics.velocityFromRotation(player.rotation, -300, player.body.acceleration);
                emitter.startFollow(player);
                emitter2.startFollow(player);
            }
            if (pad.X && axisV <= -0.1 && axisH >= 0.1){
                player.anims.play('bras_right', true);
                this.physics.velocityFromRotation(player.rotation, 300, player.body.acceleration);
                emitter.startFollow(player);
                emitter2.startFollow(player);
            }
            else if (axisV <= -0.1 && axisH >= 0.1){
                player.anims.play('left', true);
                this.physics.velocityFromRotation(player.rotation, 300, player.body.acceleration);
                emitter.startFollow(player);
                emitter2.startFollow(player);
            }
            if (axisV == 0 && axisH == 0 ){
                player.setAcceleration(0);
                emitter.stopFollow(player);
                emitter2.stopFollow(player); 
            }  
        } 
    }
    
    

</script>

</body>
</html>